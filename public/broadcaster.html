<!DOCTYPE html>
<html>
<head>
  <title>Broadcaster</title>
</head>
<body>
  <video id="localVideo" autoplay playsinline muted></video>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const video = document.getElementById('localVideo');
    let localStream = null;
    const peers = {}; // viewerId -> RTCPeerConnection

    socket.emit('broadcaster');

    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then(stream => {
        localStream = stream;
        video.srcObject = stream;
      })
      .catch(error => console.error('Error accessing media devices.', error));

    socket.on('viewer', viewerId => {
      const peer = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });
      peers[viewerId] = peer;

      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
      console.log('Tracks added to peer for viewer', viewerId);

      peer.onicecandidate = e => {
        if (e.candidate) {
          socket.emit('candidate', { to: viewerId, candidate: e.candidate });
        }
      };

      peer.createOffer().then(offer => {
        return peer.setLocalDescription(offer);
      }).then(() => {
        socket.emit('offer', { viewerId, offer: peer.localDescription });
      });

      // Answer from viewer
      socket.on('answer', ({ viewerId: from, answer }) => {
        if (from === viewerId) {
          peer.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      // ICE candidate from viewer
      socket.on('candidate', ({ from, candidate }) => {
        if (from === viewerId) {
          peer.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });
    });

    socket.on('broadcaster-disconnected', () => {
      Object.values(peers).forEach(peer => peer.close());
      location.reload();
    });
  </script>
</body>
</html>