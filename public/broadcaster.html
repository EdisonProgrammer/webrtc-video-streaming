<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Camera</title>
  <style>
    video { width: 100%; max-width: 600px; }
    button { font-size: 1.2em; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ“· Camera</h1>
  <video id="localVideo" autoplay playsinline muted></video>
  <br>
  <button id="switchBtn">ðŸ”„ ÐŸÐµÑ€ÐµÐ¼ÐºÐ½ÑƒÑ‚Ð¸ ÐºÐ°Ð¼ÐµÑ€Ñƒ</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const room = 'webrtc-room';
    const video = document.getElementById('localVideo');
    const switchBtn = document.getElementById('switchBtn');

    let pc;
    let currentFacing = 'environment'; // Ð¿Ð¾Ñ‡Ð¸Ð½Ð°Ñ”Ð¼Ð¾ Ð· Ð·Ð°Ð´Ð½ÑŒÐ¾Ñ—
    let currentStream;

    const config = {
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    };

    socket.emit('join', room);

    async function startCamera(facingMode) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode },
        audio: false
      });

      currentStream = stream;
      video.srcObject = stream;

      if (!pc) {
        pc = new RTCPeerConnection(config);
        pc.onicecandidate = e => {
          if (e.candidate) socket.emit('candidate', room, e.candidate);
        }
        const tracks = stream.getTracks();
        tracks.forEach(track => pc.addTrack(track, stream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('offer', room, offer);
      } else {
        const sender = pc.getSenders().find(s => s.track.kind === 'video');
        if (sender) {
          sender.replaceTrack(stream.getVideoTracks()[0]);
        }
      }
    }

    // ÐŸÐµÑ€ÐµÐ¼Ð¸ÐºÐ°Ð½Ð½Ñ ÐºÐ°Ð¼ÐµÑ€Ð¸
    switchBtn.addEventListener('click', () => {
      currentFacing = currentFacing === 'environment' ? 'user' : 'environment';
      startCamera(currentFacing);
    });

    socket.on('answer', answer => {
      pc.setRemoteDescription(answer);
    });

    socket.on('candidate', candidate => {
      pc.addIceCandidate(candidate);
    });

    // Ð¡Ñ‚Ð°Ñ€Ñ‚ÑƒÑ”Ð¼Ð¾ Ð¾Ð´Ñ€Ð°Ð·Ñƒ
    startCamera(currentFacing);
  </script>
</body>
</html>
