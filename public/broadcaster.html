<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞–º–µ—Ä–∞</title>
  <style>
    video { width: 100%; max-width: 600px; }
    select, button {
      font-size: 1em;
      margin: 10px 5px;
      padding: 8px;
    }
  </style>
</head>
<body>
  <h2>üì∑ –ö–∞–º–µ—Ä–∞</h2>
  <video id="localVideo" autoplay playsinline muted></video>
  <br>
  <label for="cameraSelect">üé• –û–±—Ä–∞—Ç–∏ –∫–∞–º–µ—Ä—É:</label>
  <select id="cameraSelect"></select>
  <button id="refreshBtn">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const room = 'webrtc-room';
    const video = document.getElementById('localVideo');
    const cameraSelect = document.getElementById('cameraSelect');
    const refreshBtn = document.getElementById('refreshBtn');

    let currentStream;
    let pc;

    const config = {
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    };

    socket.emit('join', room);

    async function getCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === 'videoinput');
      cameraSelect.innerHTML = '';
      videoDevices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `–ö–∞–º–µ—Ä–∞ ${cameraSelect.length + 1}`;
        cameraSelect.appendChild(option);
      });
    }

    async function startCameraById(deviceId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          deviceId: { exact: deviceId },
          width: { ideal: 1280 },
          height: { ideal: 720 },
        },
        audio: false
      });

      currentStream = stream;
      video.srcObject = stream;

      if (!pc) {
        pc = new RTCPeerConnection(config);
        pc.onicecandidate = e => {
          if (e.candidate) socket.emit('candidate', room, e.candidate);
        };

        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('offer', room, offer);
      } else {
        const sender = pc.getSenders().find(s => s.track.kind === 'video');
        if (sender) {
          sender.replaceTrack(stream.getVideoTracks()[0]);
        }
      }
    }

    cameraSelect.addEventListener('change', () => {
      const selectedId = cameraSelect.value;
      startCameraById(selectedId);
    });

    refreshBtn.addEventListener('click', getCameras);

    socket.on('answer', answer => {
      pc.setRemoteDescription(answer);
    });

    socket.on('candidate', candidate => {
      pc.addIceCandidate(candidate);
    });

    // –°—Ç–∞—Ä—Ç
    getCameras().then(() => {
      const firstId = cameraSelect.options[0]?.value;
      if (firstId) {
        startCameraById(firstId);
      }
    });
  </script>
</body>
</html>
