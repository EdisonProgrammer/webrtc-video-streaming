<!DOCTYPE html>
<html>
<head>
  <title>Viewer</title>
</head>
<body>
  <video id="remoteVideo" autoplay playsinline></video>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const video = document.getElementById('remoteVideo');
    let peer = null;

    // Запитати у користувача ID broadcaster (можна зробити автоматично, якщо один broadcaster)
    socket.on('broadcaster', () => {
      // Якщо кілька broadcaster, тут можна вибрати потрібного
      socket.emit('viewer', prompt('Введіть ID broadcaster (або залиште порожнім для першого):') || Object.keys(socket.io.engine.clients)[0]);
    });

    socket.on('offer', ({ broadcasterId, offer }) => {
      peer = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      peer.ontrack = e => {
        video.srcObject = e.streams[0];
      };

      peer.onicecandidate = e => {
        if (e.candidate) {
          socket.emit('candidate', { to: broadcasterId, candidate: e.candidate });
        }
      };

      peer.setRemoteDescription(new RTCSessionDescription(offer)).then(() => {
        return peer.createAnswer();
      }).then(answer => {
        return peer.setLocalDescription(answer);
      }).then(() => {
        socket.emit('answer', { broadcasterId, answer: peer.localDescription });
      });

      // ICE candidate from broadcaster
      socket.on('candidate', ({ from, candidate }) => {
        if (from === broadcasterId) {
          peer.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });
    });

    socket.on('broadcaster-disconnected', () => {
      if (peer) peer.close();
      video.srcObject = null;
      alert('Broadcaster disconnected');
    });
  </script>
</body>
</html>